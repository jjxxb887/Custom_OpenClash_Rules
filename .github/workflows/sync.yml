name: Sync with upstream and keep YouTube rules

on:
  schedule:
    - cron: '0 2 * * *'   # æ¯å¤© 02:00 UTC è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨æ‰§è¡Œ

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/Aethersailor/Custom_OpenClash_Rules.git || true
          git fetch upstream --no-tags

      - name: Merge upstream/main (prefer upstream)
        run: |
          git checkout main
          git merge upstream/main -X theirs --no-edit || true

      - name: Ensure rule dir and YouTube-Ads.yaml
        run: |
          mkdir -p rule
cat > rule/YouTube-Ads.yaml <<'EOF'
payload:
  # YouTube å¹¿å‘ŠåŸŸå
  - DOMAIN-SUFFIX,ads.youtube.com
  - DOMAIN-SUFFIX,ads.youtube-nocookie.com
  - DOMAIN-SUFFIX,pagead2.googlesyndication.com
  - DOMAIN-SUFFIX,googleads.g.doubleclick.net
  - DOMAIN-SUFFIX,doubleclick.net

  # YouTube è§†é¢‘å¹¿å‘Šç›¸å…³åŸŸåï¼ˆå¯èƒ½å¯¼è‡´æ¼ç½‘ï¼‰
  - DOMAIN-SUFFIX,yt3.ggpht.com
  - DOMAIN-SUFFIX,ytimg.l.google.com
  - DOMAIN-SUFFIX,yt.adfalcon.com
  - DOMAIN-SUFFIX,youtubei.googleapis.com
EOF

      - name: Patch cfg/Custom_Clash.ini (insert under [custom])
        run: |
          CFG=cfg/Custom_Clash.ini
          if [ ! -f "$CFG" ]; then
            mkdir -p cfg
            echo "[custom]" > "$CFG"
          fi

          # æ’å…¥ YouTube-Ads æœ¬åœ°è§„åˆ™
          if ! grep -q "YouTube-Ads" "$CFG"; then
            sed -i '/^\[custom\]/a ruleset=REJECT,clash-classic:./rule/YouTube-Ads.yaml,86400' "$CFG"
          fi

          # æ’å…¥ YouTube åœ¨çº¿è§„åˆ™
          if ! grep -q "blackmatrix7/ios_rule_script" "$CFG"; then
            sed -i '/^\[custom\]/a ruleset=ğŸ“¹ YouTube,clash-classic:https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.yaml,86400' "$CFG"
          fi

      - name: Commit & push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add rule cfg .github/workflows || true
          git commit -m "Sync upstream and restore YouTube rules" || echo "No changes to commit"
          git push origin main || echo "Push failed"
